<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ext="http://aries.apache.org/blueprint/xmlns/blueprint-ext/v1.2.0"
  xsi:schemaLocation="
  http://www.osgi.org/xmlns/blueprint/v1.0.0 /Users/ajs6f/Documents/sidora/scratch/blueprint.xsd
  http://camel.apache.org/schema/blueprint https://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

  <!-- OSGI blueprint property placeholder -->
  <ext:property-placeholder id="blueprint.placeholder">
    <ext:default-properties>
      <ext:property name="shim.port" value="9191"/>
      <ext:property name="fcrepo3.uri" value="http://localhost:8080/fedora"/>
    </ext:default-properties>
  </ext:property-placeholder>

  <camelContext xmlns="http://camel.apache.org/schema/blueprint" streamCache="true">

    <!-- TODO for diagnostics only -->
    <streamCaching id="myCacheConfig" bufferSize="16384" spoolDirectory="/tmp/cachedir"
      spoolThreshold="1"/>

    <restConfiguration component="restlet" port="{{shim.port}}"/>

    <rest path="/shim">

      <get uri="/{Fcrepo3Pid}/models">
        <route>
          <to uri="log:shim.models"/>
          <to uri="velocity:sparql/getcontentmodels.vm"/>
          <to uri="log:shim.models.getmodels"/>
          <to uri="direct:sparql"/>
        </route>
      </get>
    </rest>

    <route>
      <from uri="direct:sparql"/>
      <to uri="log:shim.sparql"/>
      <setHeader headerName="Content-Type">
        <constant>application/x-www-form-urlencoded</constant>
      </setHeader>
      <setHeader headerName="CamelHttpChunked">
        <constant>false</constant>
      </setHeader>
      <setHeader headerName="CamelHttpMethod">
        <constant>POST</constant>
      </setHeader>
      <setHeader headerName="CamelHttpUri">
        <constant>{{fcrepo3.uri}}/risearch</constant>
      </setHeader>
      <to uri="velocity:sparql/package.vm"/>
      <to uri="log:shim.sparql.packaged"/>
      <to uri="http4://dummy?authUsername=fedoraAdmin&amp;authPassword=fedoraAdmin"/>
      <log message="SPARQL result: \n${body}"/>
      <to uri="log:shim.sparql.result"/>
      <removeHeader headerName="CamelHttpMethod"/>
      <removeHeader headerName="CamelHttpChunked"/>
      <removeHeader headerName="Content-Type"/>
    </route>


  </camelContext>

</blueprint>
